on: [push, pull_request]

jobs:
  test-linux:
    runs-on: ubuntu-22.04  # <--- CRITICAL: Pin this to 22.04 to match the URL below
    env:
      # Tell uv where to find the Linux wheels
      UV_FIND_LINKS: "https://extras.wxpython.org/wxPython4/extras/linux/gtk3/ubuntu-22.04"
    steps:
      - uses: actions/checkout@v4

      # 1. Install System Dependencies (Still required for wxPython on Linux)
      #    wxPython needs these C++ libraries to run, even with uv.
      - name: Install Linux System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libnotify-dev libsdl2-dev
          sudo apt-get install -y xvfb
          WHEEL_URL="https://extras.wxpython.org/wxPython4/extras/linux/gtk3/ubuntu-22.04/wxPython-4.2.4-cp311-cp311-linux_x86_64.whl"
          wget $WHEEL_URL

      # 2. Setup uv
      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true  # Automatically caches your dependencies

      # 3. Install Python & Dependencies
      #    Option A: If you have a 'pyproject.toml' or 'uv.lock' (Recommended)
      - name: Install dependencies
        run: |
          uv sync --group dev
          uv add wxpython-4.2.4-cp311-cp311-linux_x86_64.whl

      #    Option B: If you just use requirements.txt (Simple)
      #    - run: uv pip install --system -r requirements.txt
      #    - run: uv pip install --system wxPython

      # 4. Run Tests
      #    We wrap the command in 'xvfb-run' to fake the screen,
      #    and use 'uv run' to ensure we use the correct environment.
      - name: Run Tests
        run: |
          xvfb-run --auto-servernum --server-args="-screen 0 1920x1080x24" uv run pytest
