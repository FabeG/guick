on: [push, pull_request]

jobs:
  test-linux:
    runs-on: ubuntu-22.04  # <--- CRITICAL: Pin this to 22.04 to match the URL below
    env:
      # Tell uv where to find the Linux wheels
      UV_FIND_LINKS: "https://extras.wxpython.org/wxPython4/extras/linux/gtk3/ubuntu-22.04"
    steps:
      - uses: actions/checkout@v4

      # 1. Install System Dependencies (Still required for wxPython on Linux)
      #    wxPython needs these C++ libraries to run, even with uv.
      - name: Install Linux System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libnotify-dev libsdl2-dev
          sudo apt-get install -y xvfb

      # 2. Setup uv
      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true  # Automatically caches your dependencies

      # 3. Install Python & Dependencies
      #    Option A: If you have a 'pyproject.toml' or 'uv.lock' (Recommended)
      - name: Install dependencies
        run: |
          uv sync --group dev
          uv add wxpython --find-links https://extras.wxpython.org/wxPython4/extras/linux/gtk3/ubuntu-22.04

      #    Option B: If you just use requirements.txt (Simple)
      #    - run: uv pip install --system -r requirements.txt
      #    - run: uv pip install --system wxPython

      # 4. Run Tests
      #    We wrap the command in 'xvfb-run' to fake the screen,
      #    and use 'uv run' to ensure we use the correct environment.
      - name: Run Tests
        id: tests
        run: |
          set -o pipefail
          xvfb-run --auto-servernum --server-args="-screen 0 1920x1080x24" uv run pytest --cov=. --cov-report=xml --cov-report=html --cov-report=term-missing -v --tb=long 2>&1 | tee test_output.log
          cat test_output.log
        continue-on-error: true

      - name: Check test results
        if: steps.tests.outcome == 'failure'
        run: exit 1

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          file: ./coverage.xml

      - name: Upload HTML coverage as artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: htmlcov/

      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs
          path: test_output.log

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: github.ref == 'refs/heads/main'  # Only on main branch
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./htmlcov
          publish_branch: gh-pages
